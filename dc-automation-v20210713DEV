# variable declaration
$logstashPath = 'D:\logstash-7.12.1\bin\logstash'
$logPath = 'D:\logstash-7.12.1\logs'
$yiicPath = 'G:\Hotsoft\dev\Decorilla\decorilla\protected\yiic'
$logstashConfPath = 'G:\Hotsoft\dev\Decorilla\decorilla\protected\config\logstash'
$Env:jdbc_driver_library = 'D:\mysql-connector-java-8.0.24\mysql-connector-java-8.0.24.jar'
$Env:jdbc_driver_class = 'com.mysql.jdbc.Driver'
$Env:elasticsearch_hosts = 'localhost:9200'
$Env:collection_index = 'decorilla-collection'
$Env:vendors_index = 'decorilla-vendors'
$Env:colours_index = 'decorilla-colours'
$Env:artstyles_index = 'decorilla-artstyles'
$Env:brands_index = 'decorilla-brands'
# Instead of declaring these variables here, they can be created in the keystore by running these commands:
# \bin\logstash-keystore create
# \bin\logstash-keystore add jdbc_connection_string
# \bin\logstash-keystore add jdbc_user
# \bin\logstash-keystore add jdbc_password
# More info on https://www.elastic.co/guide/en/logstash/current/keystore.html
$Env:jdbc_connection_string = 'jdbc:mysql://localhost:3306/decorilla?useSSL=true&user=root&sessionVariables=group_concat_max_len=99999999,sort_buffer_size=1048576'
$Env:jdbc_user = 'root'
$Env:jdbc_password = ''

# startup
Write-Host "$(Get-Date -format 'u') Disabling the Decorilla Collection..."
$proc = Start-Process $yiicPath disabledc -PassThru 
$proc.WaitForExit()
Write-Host "$(Get-Date -format 'u') Executing daily importers..."
$proc = Start-Process $yiicPath dailyimporters -PassThru 
$proc.WaitForExit()
Write-Host "$(Get-Date -format 'u') Executing daily post import..."
$proc = Start-Process $yiicPath  -ArgumentList "dailypostimport --verbose=1" -PassThru 
$proc.WaitForExit()
# optimizing collection
Write-Host "$(Get-Date -format 'u') Optimizing collection index..."
Invoke-RestMethod -Method PUT -ContentType "application/json" -uri "http://localhost:9200/decorilla-collection/_settings?pretty" -Body '{ "index" : { "refresh_interval" : "30s", "number_of_replicas" : "0", "blocks.read_only_allow_delete" : "false" } }'
# collection index
Write-Host "$(Get-Date -format 'u') Creating collection index..."
$proc = Start-Process -FilePath "$logstashPath" -ArgumentList "-f $logstashConfPath\decorilla-collection.conf --path.data=$logPath\decorilla-collection$(Get-Date -Format 'yyyyMMdd_HHmmss')" -PassThru 
$proc.WaitForExit()
$proc = Start-Process -FilePath "$yiicPath" -ArgumentList "slackimportersmessage --logstashIndex=decorilla-collection" -PassThru 
$proc.WaitForExit()
# vendor index
Write-Host "$(Get-Date -format 'u') Creating vendors index..."
$proc = Start-Process -FilePath "$logstashPath" -ArgumentList "-f $logstashConfPath\decorilla-vendors.conf --path.data=$logPath\decorilla-vendors$(Get-Date -Format 'yyyyMMdd_HHmmss')" -PassThru 
$proc.WaitForExit()
$proc = Start-Process -FilePath "$yiicPath" -ArgumentList "slackimportersmessage --logstashIndex=decorilla-vendors" -PassThru 
$proc.WaitForExit()
# colours index
Write-Host "$(Get-Date -format 'u') Creating colours index..."
$proc = Start-Process -FilePath "$logstashPath" -ArgumentList "-f $logstashConfPath\decorilla-colours.conf --path.data=$logPath\decorilla-colours$(Get-Date -Format 'yyyyMMdd_HHmmss')" -PassThru 
$proc.WaitForExit()
$proc = Start-Process -FilePath "$yiicPath" -ArgumentList "slackimportersmessage --logstashIndex=decorilla-colours" -PassThru 
$proc.WaitForExit()
# artstyles index
Write-Host "$(Get-Date -format 'u') Creating artstyles index..."
$proc = Start-Process -FilePath "$logstashPath" -ArgumentList "-f $logstashConfPath\decorilla-artstyles.conf --path.data=$logPath\decorilla-artstyles$(Get-Date -Format 'yyyyMMdd_HHmmss')" -PassThru 
$proc.WaitForExit()
$proc = Start-Process -FilePath "$yiicPath" -ArgumentList "slackimportersmessage --logstashIndex=decorilla-artstyles" -PassThru 
$proc.WaitForExit()
# brands index
Write-Host "$(Get-Date -format 'u') Creating brands index..."
$proc = Start-Process -FilePath "$logstashPath" -ArgumentList "-f $logstashConfPath\decorilla-brands.conf --path.data=$logPath\decorilla-brands$(Get-Date -Format 'yyyyMMdd_HHmmss')" -PassThru 
$proc.WaitForExit()
$proc = Start-Process -FilePath "$yiicPath" -ArgumentList "slackimportersmessage --logstashIndex=decorilla-brands" -PassThru 
$proc.WaitForExit()
# wrapping up
Write-Host "$(Get-Date -format 'u') Enabling the Decorilla Collection..."
$proc = Start-Process $yiicPath enabledc -PassThru 
$proc.WaitForExit()
Write-Host "$(Get-Date -format 'u') Finished!!!"
